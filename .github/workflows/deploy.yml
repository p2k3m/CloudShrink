name: deploy

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-south-1
      DEPLOY_ROLE_ARN: arn:aws:iam::957650740525:role/GitHubActions-CloudShrink
      AWS_ACCOUNT_ID: '957650740525'
      STACK_NAME: cloudshrink
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          output-credentials: true

      - name: Build frontend
        run: |
          cd frontend
          npm install
          npm run build

      - name: Package backend
        run: |
          mkdir -p artifacts
          zip -j artifacts/api_handler-${{ github.sha }}.zip backend/lambdas/api_handler/app.py
          zip -j artifacts/discovery_worker-${{ github.sha }}.zip backend/lambdas/discovery_worker/app.py
          zip -j artifacts/evaluation_worker-${{ github.sha }}.zip backend/lambdas/evaluation_worker/app.py
          zip -j artifacts/step_trigger-${{ github.sha }}.zip backend/lambdas/step_trigger/app.py

      - name: Create Artifacts Bucket
        run: |
          aws s3api head-bucket --bucket ${{ env.AWS_ACCOUNT_ID }}-${{ env.STACK_NAME }}-artifacts || \
          aws s3api create-bucket \
            --bucket ${{ env.AWS_ACCOUNT_ID }}-${{ env.STACK_NAME }}-artifacts \
            --region ${{ env.AWS_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }}

      - name: Upload artifacts
        run: |
          aws s3 cp artifacts s3://${{ env.AWS_ACCOUNT_ID }}-${{ env.STACK_NAME }}-artifacts/ --recursive
          aws s3 cp statemachine/workflow.asl.json s3://${{ env.AWS_ACCOUNT_ID }}-${{ env.STACK_NAME }}-artifacts/statemachine/workflow.asl.json

      - name: Deploy CloudFormation
        run: |
          aws cloudformation deploy \
            --stack-name ${{ env.STACK_NAME }} \
            --template-file infrastructure/central/template.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              StackName=${{ env.STACK_NAME }} \
              ArtifactsBucket=${{ env.AWS_ACCOUNT_ID }}-${{ env.STACK_NAME }}-artifacts \
              ApiHandlerKey=api_handler-${{ github.sha }}.zip \
              DiscoveryWorkerKey=discovery_worker-${{ github.sha }}.zip \
              EvaluationWorkerKey=evaluation_worker-${{ github.sha }}.zip \
              StepTriggerKey=step_trigger-${{ github.sha }}.zip \
              StateMachineKey=statemachine/workflow.asl.json

      - name: Sync frontend
        run: |
          aws s3 sync frontend/dist s3://${{ env.AWS_ACCOUNT_ID }}-${{ env.STACK_NAME }}-frontend
